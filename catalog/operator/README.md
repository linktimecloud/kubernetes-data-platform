### 1.简介
Operator 是 Kubernetes 的扩展软件， 它利用定制资源管理应用及其组件。 Operator 遵循 Kubernetes 的理念，特别是在控制器方面。

Operator 模式旨在记述（正在管理一个或一组服务的）运维人员的关键目标。 这些运维人员负责一些特定的应用和 Service，他们需要清楚地知道系统应该如何运行、如何部署以及出现问题时如何处理。

在 Kubernetes 上运行工作负载的人们都喜欢通过自动化来处理重复的任务。 Operator 模式会封装你编写的（Kubernetes 本身提供功能以外的）任务自动化代码。


### 2.Operator特征
Operator的核心目的都是利用新的领域知识来扩展其编排器的底层API。 例如，Kubernetes中的编排平台通过 Pod 和 Service 对象本机理解容器和第 4 层负载均衡器等内容。 Operator为更复杂的系统和应用程序添加新功能。 例如，prometheus-operator 引入了新的对象类型 Prometheus，通过对部署和运行 Prometheus 服务器的高级支持来扩展 Kubernetes。

Operator提供的功能可以分为三个总体类别：动态配置、操作自动化和领域知识。

#### 动态配置
从软件开发的早期阶段开始，配置软件的方式主要有两种：配置文件和环境变量。 云原生世界创建了更新的进程，这些进程基于在启动时查询众所周知的 API。 大多数现有软件都依赖于这两个选项的组合。 Kubernetes 自然提供了许多工具来启用自定义配置（例如 ConfigMaps 和 Secrets）。 由于大多数 Kubernetes 资源都是通用的，因此它们不了解修改给定应用程序的任何细节。 相比之下，operator可以定义新的自定义对象类型（自定义资源），以更好地表达 Kubernetes 上下文中特定应用程序的配置。

允许更好的验证和数据结构可以减少小配置错误的可能性，并提高团队自助服务的能力。 这消除了每个团队按照传统要求理解底层编排器或目标应用程序的要求。 这可以包括渐进式默认值等内容，其中使用一些高级设置来填充最佳实践驱动的配置文件或自适应配置，例如根据集群大小调整资源使用情况以匹配可用硬件或预期负载。

#### 运营自动化
除了自定义资源之外，大多数operator还至少包含一个自定义控制器。 这些控制器是像其他控制器一样在编排器内部运行的守护进程，但连接到底层 API 并提供常见或重复任务的自动化。 这与编排器（如 Kubernetes）的实现方式相同。 到目前为止，您可能已经在您的旅程中看到过 kube-controller-manager 或 cloud-controller-manager。 然而，正如配置所证明的那样，operator可以通过更高级别的自动化来扩展和增强编排器，例如部署集群软件、提供自动备份和恢复或基于负载的动态扩展。

通过将这些常见的操作任务放入代码中，可以确保它们以标准化的方式可重复、可测试和可升级。 让人类远离频繁任务的循环还可以确保步骤不会被遗漏或排除，并且任务的不同部分不会彼此不同步。 和以前一样，这可以通过减少花在无聊但重要的维护任务（例如应用程序备份）上的时间来提高团队自主权。

#### 领域知识
与操作自动化类似，它可以写入operator中以对有关特定软件或流程的专业领域知识进行编码。 一个常见的例子是应用程序升级。 虽然一个简单的无状态应用程序可能只需要部署的滚动升级； 数据库和其他有状态应用程序通常需要按顺序执行非常具体的步骤才能安全地执行升级。 operator可以自主处理此问题，因为它知道您当前和请求的版本，并且可以在需要时运行专门的升级代码。 更一般地说，这可以适用于云原生之前的环境使用手动检查表的任何内容（有效地将operator用作可执行运行手册）。 利用自动化领域知识的另一种常见方法是错误修复。 例如，Kubernetes 内置的修复行为大多以“重新启动容器直到其工作”开始和结束，这是一个强大的解决方案，但通常不是最好或最快的解决方案。 operator可以监控其应用程序，并通过特定行为对错误做出反应，以解决错误或在无法自动解决的情况下升级问题。 

### 3. Operator能力
Operator能够通过解决许多不同的任务来协助操作应用程序或其他托管组件。 在谈论运营商时，第一个也是最广为人知的功能是安装和升级有状态应用程序的能力。 然而，Operator可以管理应用程序的整个生命周期，而无需手动输入安装/升级。

以下各节应概述Operator可以拥有的功能以及Operator实现这些功能后用户可以期待什么。

#### 安装应用程序/获取应用程序的所有权
Operator应该能够配置和设置所有所需的资源，因此在安装过程中不需要手动工作。 Operator必须检查并验证所配置的资源是否按预期工作并准备好使用。

Operator还应该能够识别在安装过程之前配置的资源，并且只拥有它们的所有权以供以后使用。 在这种情况下，所有权流程应该是无缝的并且不会导致停机。 所有权流程的目的是使资源能够轻松迁移到运营商。

Operator应在此过程中报告资源的版本及其健康状况。

#### 升级应用程序
Operator应该能够升级应用程序/资源的版本。 Operator应该知道如何更新所需的依赖项并执行自定义命令，例如运行数据库迁移。

如果过程中出现问题，Operator应该监控更新和回滚。

操作人员应在此过程中报告资源的版本及其健康状况。 如果出现错误，则报告的版本应该是当前正在使用的版本。

#### 备份
此功能适用于管理数据并确保Operator能够创建一致备份的Operator。 此备份的方式应确保运营商的用户可以确定，如果数据丢失或受到损害，可以恢复以前的版本。 此外，提供的状态信息应提供有关备份上次运行时间及其位置的信息。

首先，备份由人或其他触发器（例如时间触发器）触发。 Operator指示其监视的资源（应用程序）设置一致状态（如一致快照）。 然后，使用适当的工具将应用程序的数据备份到外部存储。 这可以是一步过程（直接备份到外部存储），也可以是多个步骤，例如首先写入持久卷，然后写入外部存储。 外部存储可能是本地 NFS/CIFS 共享（或任何其他网络文件系统），也可能是云提供商基础设施上的对象存储/存储桶。 无论备份失败还是成功，（备份的）状态（包括备份的应用程序版本和备份位置）都可能会写入自定义资源的状态部分。

#### 从备份恢复
Operator的恢复能力可以帮助用户从成功的备份中恢复应用程序状态。 因此，应恢复应用程序状态（应用程序版本和数据）。

可能有很多方法可以实现这一目标。一种可能的方法是当前应用程序状态也得到备份（包括配置），因此用户只需为应用程序创建自定义资源并指向备份。 Operator将读取配置、恢复应用程序版本并恢复数据。 另一种可能的解决方案可能是用户仅备份数据并且可能必须指定所使用的应用程序版本。 然而，通过这两种方式，Operator可以确保应用程序在使用指定备份中的数据后启动并运行。

#### 自动修复
Operator的自动修复能力应确保它能够从更复杂的故障状态中恢复应用程序，而健康检查（实时和就绪探针）等机制可能无法处理或检测到该状态。 因此，操作人员需要对应用有深入的了解。 这可以通过可能指示应用程序故障或错误的指标来实现，也可以通过处理健康检查等 Kubernetes 机制来实现。